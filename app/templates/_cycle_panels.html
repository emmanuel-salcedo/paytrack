{% set snapshot = current_cycle_snapshot %}
<section class="grid" aria-label="Cycle snapshots" style="grid-template-columns: 1fr;">
  <article class="card cycle-card">
      <div class="section-head">
        <div>
          <h2>{{ snapshot.label }}</h2>
          <p class="muted">Cycle actions and totals update live via HTMX.</p>
        </div>
        <span class="status-pill cycle-count-badge">{{ snapshot.occurrence_count }} items</span>
      </div>
      <div class="row"><span>Range</span><strong>{{ snapshot.cycle_start }} -> {{ snapshot.cycle_end }}</strong></div>
      <div class="row"><span>Scheduled</span><strong class="amount-text">${{ '%.2f'|format(snapshot.scheduled_total) }}</strong></div>
      <div class="row"><span>Paid</span><strong class="amount-text amount-positive">${{ '%.2f'|format(snapshot.paid_total) }}</strong></div>
      <div class="row"><span>Skipped</span><strong class="amount-text amount-warn">${{ '%.2f'|format(snapshot.skipped_total) }}</strong></div>
      <div class="row"><span>Remaining</span><strong class="amount-text amount-strong">${{ '%.2f'|format(snapshot.remaining_total) }}</strong></div>

      {% if snapshot.occurrences %}
        <div class="table-wrap">
        <table class="payments-table compact-table cycle-table">
          <thead>
            <tr>
              <th>Due</th>
              <th>Payment</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for row in snapshot.occurrences %}
              <tr>
                <td data-label="Due">{{ row.due_date }}</td>
                <td data-label="Payment">{{ row.payment_name }}</td>
                <td data-label="Amount" class="amount-cell">${{ '%.2f'|format(row.expected_amount) }}</td>
                <td data-label="Status"><span class="status-pill status-{{ row.status }}">{{ row.status }}</span></td>
                <td data-label="Actions" class="actions-cell">
                  {% if row.status == "scheduled" %}
                    <div class="action-group quick-actions">
                      <form
                        hx-post="/occurrences/{{ row.occurrence_id }}/mark-paid"
                        hx-target="#interactive-panels"
                        hx-swap="outerHTML"
                        method="post"
                        class="inline-form"
                      >
                        <input type="hidden" name="show_archived" value="{{ '1' if show_archived else '0' }}">
                        <button type="submit" class="btn-compact">Mark Paid</button>
                      </form>
                      <form
                        hx-post="/occurrences/{{ row.occurrence_id }}/skip"
                        hx-target="#interactive-panels"
                        hx-swap="outerHTML"
                        method="post"
                        class="inline-form"
                      >
                        <input type="hidden" name="show_archived" value="{{ '1' if show_archived else '0' }}">
                        <button type="submit" class="btn-compact">Skip</button>
                      </form>
                    </div>
                    <details>
                      <summary>Edit Paid</summary>
                      <form
                        hx-post="/occurrences/{{ row.occurrence_id }}/mark-paid"
                        hx-target="#interactive-panels"
                        hx-swap="outerHTML"
                        method="post"
                        class="stack"
                      >
                        <input type="hidden" name="show_archived" value="{{ '1' if show_archived else '0' }}">
                        <label>
                          <span>Amount Paid</span>
                          <input type="number" name="amount_paid" min="0" step="0.01" placeholder="{{ '%.2f'|format(row.expected_amount) }}">
                        </label>
                        <label>
                          <span>Paid Date</span>
                          <input type="date" name="paid_date">
                        </label>
                        <button type="submit">Save Paid</button>
                      </form>
                    </details>
                  {% elif row.status == "completed" %}
                    <div class="action-group quick-actions">
                      <form
                        hx-post="/occurrences/{{ row.occurrence_id }}/undo-paid"
                        hx-target="#interactive-panels"
                        hx-swap="outerHTML"
                        method="post"
                        class="inline-form"
                      >
                        <input type="hidden" name="show_archived" value="{{ '1' if show_archived else '0' }}">
                        <button type="submit" class="btn-compact">Undo</button>
                      </form>
                    </div>
                    <details>
                      <summary>Edit Paid</summary>
                      <form
                        hx-post="/occurrences/{{ row.occurrence_id }}/mark-paid"
                        hx-target="#interactive-panels"
                        hx-swap="outerHTML"
                        method="post"
                        class="stack"
                      >
                        <input type="hidden" name="show_archived" value="{{ '1' if show_archived else '0' }}">
                        <label>
                          <span>Amount Paid</span>
                          <input type="number" name="amount_paid" min="0" step="0.01">
                        </label>
                        <label>
                          <span>Paid Date</span>
                          <input type="date" name="paid_date">
                        </label>
                        <button type="submit">Update Paid</button>
                      </form>
                    </details>
                  {% else %}
                    <span class="muted">-</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        </div>
      {% else %}
        <p class="muted">No generated occurrences in this cycle yet.</p>
      {% endif %}
  </article>
</section>
