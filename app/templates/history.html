{% extends "base.html" %}

{% block title %}PayTrack | History{% endblock %}

{% block content %}
<section class="hero">
  <span class="pill">History</span>
  <h1>Occurrence History</h1>
  <p class="muted">Audit completed, skipped, canceled, and scheduled occurrences with simple filters.</p>
</section>

<section class="history-layout" aria-label="History workspace">
  <aside class="card history-filters">
    <h2>Filters</h2>
    <form method="get" action="/history" class="stack">
      <label>
        <span>Status</span>
        <select name="status">
          <option value="" {% if not filters.status %}selected{% endif %}>All</option>
          <option value="scheduled" {% if filters.status == "scheduled" %}selected{% endif %}>Scheduled</option>
          <option value="completed" {% if filters.status == "completed" %}selected{% endif %}>Completed</option>
          <option value="skipped" {% if filters.status == "skipped" %}selected{% endif %}>Skipped</option>
          <option value="canceled" {% if filters.status == "canceled" %}selected{% endif %}>Canceled</option>
        </select>
      </label>
      <label>
        <span>Start Date</span>
        <input type="date" name="start_date" value="{{ filters.start_date }}">
      </label>
      <label>
        <span>End Date</span>
        <input type="date" name="end_date" value="{{ filters.end_date }}">
      </label>
      <label>
        <span>Search</span>
        <input type="text" name="q" value="{{ filters.q }}" placeholder="Payment name">
      </label>
      <label>
        <span>Sort</span>
        <select name="sort">
          <option value="due_desc" {% if history_sort == 'due_desc' %}selected{% endif %}>Due Date (Newest)</option>
          <option value="due_asc" {% if history_sort == 'due_asc' %}selected{% endif %}>Due Date (Oldest)</option>
          <option value="paid_desc" {% if history_sort == 'paid_desc' %}selected{% endif %}>Paid Date (Newest)</option>
        </select>
      </label>
      <label>
        <span>Rows Per Page</span>
        <select name="per_page">
          <option value="10" {% if history_per_page == 10 %}selected{% endif %}>10</option>
          <option value="25" {% if history_per_page == 25 %}selected{% endif %}>25</option>
          <option value="50" {% if history_per_page == 50 %}selected{% endif %}>50</option>
        </select>
      </label>
      <input type="hidden" name="page" value="1">
      <div class="inline-form">
        <button type="submit">Apply Filters</button>
        <a class="link-btn" href="/history">Reset</a>
      </div>
    </form>
  </aside>

  <section class="card history-results" aria-label="History table">
    <div class="section-head">
      <div>
        <h2>Occurrences</h2>
        <p class="muted">Showing {{ history_rows|length }} of {{ history_total }} rows{% if filters.status %} for status "{{ filters.status }}"{% endif %}.</p>
      </div>
      <a class="link-btn" href="/dashboard">Back to Dashboard</a>
    </div>

    {% if history_rows %}
      <table class="payments-table">
        <thead>
          <tr>
            <th>Due Date</th>
            <th>Payment</th>
            <th>Status</th>
            <th>Expected</th>
            <th>Paid</th>
            <th>Paid Date</th>
          </tr>
        </thead>
        <tbody>
          {% for row in history_rows %}
            <tr>
              <td>{{ row.due_date }}</td>
              <td>{{ row.payment_name }}</td>
              <td><span class="status-pill status-{{ row.status }}">{{ row.status }}</span></td>
              <td>${{ '%.2f'|format(row.expected_amount) }}</td>
              <td>
                {% if row.amount_paid is not none %}
                  ${{ '%.2f'|format(row.amount_paid) }}
                {% else %}
                  <span class="muted">-</span>
                {% endif %}
              </td>
              <td>{{ row.paid_date or "-" }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="pager-row">
        <span class="muted">Page {{ history_page_num }}</span>
        <div class="inline-form">
          {% if history_has_prev %}
            <a class="link-btn" href="/history?status={{ filters.status }}&start_date={{ filters.start_date }}&end_date={{ filters.end_date }}&q={{ filters.q }}&sort={{ history_sort }}&per_page={{ history_per_page }}&page={{ history_page_num - 1 }}">Previous</a>
          {% endif %}
          {% if history_has_next %}
            <a class="link-btn" href="/history?status={{ filters.status }}&start_date={{ filters.start_date }}&end_date={{ filters.end_date }}&q={{ filters.q }}&sort={{ history_sort }}&per_page={{ history_per_page }}&page={{ history_page_num + 1 }}">Next</a>
          {% endif %}
        </div>
      </div>
    {% else %}
      <p class="muted">No occurrences match the current filters.</p>
    {% endif %}
  </section>
</section>
{% endblock %}
