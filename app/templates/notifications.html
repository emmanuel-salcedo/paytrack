{% extends "base.html" %}

{% block title %}PayTrack | Notifications{% endblock %}

{% block content %}
<section class="hero">
  <span class="pill">Notifications</span>
  <h1>Notifications Center</h1>
  <p class="muted">Unread: {{ notifications_unread_count }}{% if notifications_notice %} | {{ notifications_notice }}{% endif %}</p>
</section>

{% if notifications_error %}
  <p class="error" role="alert">{{ notifications_error }}</p>
{% endif %}

<section class="grid notifications-grid" aria-label="Notifications controls and list">
  <article class="card">
    <h2>Automation Controls</h2>
    <p class="muted">Run notification jobs manually for testing or force the daily summary without waiting for the scheduled time.</p>
    <div class="stack" style="margin-top: .5rem;">
      <form method="post" action="/notifications/run-jobs-once-today" class="inline-form">
        <button type="submit">Run Jobs Once Today</button>
      </form>
      <form method="post" action="/notifications/run-jobs" class="inline-form">
        <button type="submit">Run Jobs Now</button>
      </form>
      <form method="post" action="/notifications/run-daily-summary-now" class="inline-form">
        <button type="submit">Force Daily Summary Now</button>
      </form>
      <form method="post" action="/notifications/mark-all-read" class="inline-form">
        <button type="submit">Mark All Read</button>
      </form>
    </div>
  </article>

  <article class="card">
    <div class="section-head">
      <div>
        <h2>In-App Notifications</h2>
        <p class="muted">Latest notifications and delivery outcomes from manual and automated jobs.</p>
      </div>
      <form method="get" action="/notifications" class="inline-form">
        <label>
          <span>Sort</span>
          <select name="sort">
            <option value="newest" {% if notifications_sort == 'newest' %}selected{% endif %}>Newest</option>
            <option value="oldest" {% if notifications_sort == 'oldest' %}selected{% endif %}>Oldest</option>
            <option value="unread_first" {% if notifications_sort == 'unread_first' %}selected{% endif %}>Unread First</option>
          </select>
        </label>
        <label>
          <span>Rows</span>
          <select name="per_page">
            <option value="10" {% if notifications_per_page == 10 %}selected{% endif %}>10</option>
            <option value="20" {% if notifications_per_page == 20 %}selected{% endif %}>20</option>
            <option value="50" {% if notifications_per_page == 50 %}selected{% endif %}>50</option>
          </select>
        </label>
        <input type="hidden" name="page" value="1">
        <input type="hidden" name="log_page" value="{{ delivery_log_page_num }}">
        <input type="hidden" name="log_per_page" value="{{ delivery_log_per_page }}">
        <input type="hidden" name="log_sort" value="{{ delivery_log_sort }}">
        <button type="submit">Apply</button>
      </form>
    </div>

    {% if notifications %}
      <table class="payments-table">
        <thead>
          <tr>
            <th>When</th>
            <th>Type</th>
            <th>Title</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for row in notifications %}
            <tr>
              <td>{{ row.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
              <td>{{ row.type }}</td>
              <td>
                <div><strong>{{ row.title }}</strong></div>
                <div class="muted">{{ row.body }}</div>
              </td>
              <td>
                {% if row.is_read %}
                  <span class="status-pill status-completed">read</span>
                {% else %}
                  <span class="status-pill status-scheduled">unread</span>
                {% endif %}
              </td>
              <td>
                {% if not row.is_read %}
                  <form method="post" action="/notifications/{{ row.id }}/read">
                    <button type="submit">Mark Read</button>
                  </form>
                {% else %}
                  <span class="muted">-</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="pager-row">
        <span class="muted">Showing {{ notifications|length }} of {{ notifications_total }} notifications (page {{ notifications_page_num }})</span>
        <div class="inline-form">
          {% if notifications_has_prev %}
            <a class="link-btn" href="/notifications?page={{ notifications_page_num - 1 }}&per_page={{ notifications_per_page }}&sort={{ notifications_sort }}&log_page={{ delivery_log_page_num }}&log_per_page={{ delivery_log_per_page }}">Previous</a>
          {% endif %}
          {% if notifications_has_next %}
            <a class="link-btn" href="/notifications?page={{ notifications_page_num + 1 }}&per_page={{ notifications_per_page }}&sort={{ notifications_sort }}&log_page={{ delivery_log_page_num }}&log_per_page={{ delivery_log_per_page }}">Next</a>
          {% endif %}
        </div>
      </div>
    {% else %}
      <p class="muted">No notifications yet.</p>
    {% endif %}
  </article>
</section>

<section class="card" aria-label="Notification delivery log" style="margin-top: 1rem;">
  <div class="section-head">
    <div>
      <h2>Delivery Log</h2>
      <p class="muted">Read-only `notification_log` entries for dedup and send status debugging.</p>
    </div>
    <form method="get" action="/notifications" class="inline-form">
      <label>
        <span>Type</span>
        <input type="text" name="log_type" value="{{ delivery_log_filters.type }}" placeholder="daily_summary">
      </label>
      <label>
        <span>Channel</span>
        <select name="log_channel">
          <option value="" {% if not delivery_log_filters.channel %}selected{% endif %}>All</option>
          <option value="in_app" {% if delivery_log_filters.channel == 'in_app' %}selected{% endif %}>in_app</option>
          <option value="telegram" {% if delivery_log_filters.channel == 'telegram' %}selected{% endif %}>telegram</option>
        </select>
      </label>
      <label>
        <span>Status</span>
        <select name="log_status">
          <option value="" {% if not delivery_log_filters.status %}selected{% endif %}>All</option>
          <option value="pending" {% if delivery_log_filters.status == 'pending' %}selected{% endif %}>pending</option>
          <option value="sent" {% if delivery_log_filters.status == 'sent' %}selected{% endif %}>sent</option>
          <option value="error" {% if delivery_log_filters.status == 'error' %}selected{% endif %}>error</option>
        </select>
      </label>
      <label>
        <span>Start</span>
        <input type="date" name="log_start_date" value="{{ delivery_log_filters.start_date }}">
      </label>
      <label>
        <span>End</span>
        <input type="date" name="log_end_date" value="{{ delivery_log_filters.end_date }}">
      </label>
      <label>
        <span>Log Rows</span>
        <select name="log_per_page">
          <option value="10" {% if delivery_log_per_page == 10 %}selected{% endif %}>10</option>
          <option value="20" {% if delivery_log_per_page == 20 %}selected{% endif %}>20</option>
          <option value="50" {% if delivery_log_per_page == 50 %}selected{% endif %}>50</option>
        </select>
      </label>
      <label>
        <span>Log Sort</span>
        <select name="log_sort">
          <option value="newest" {% if delivery_log_sort == 'newest' %}selected{% endif %}>Newest</option>
          <option value="oldest" {% if delivery_log_sort == 'oldest' %}selected{% endif %}>Oldest</option>
        </select>
      </label>
      <input type="hidden" name="page" value="{{ notifications_page_num }}">
      <input type="hidden" name="per_page" value="{{ notifications_per_page }}">
      <input type="hidden" name="sort" value="{{ notifications_sort }}">
      <input type="hidden" name="log_page" value="1">
      <button type="submit">Apply</button>
      <a class="link-btn" href="/notifications?page={{ notifications_page_num }}&per_page={{ notifications_per_page }}&sort={{ notifications_sort }}&log_sort={{ delivery_log_sort }}">Clear Log Filters</a>
    </form>
  </div>

  {% if delivery_logs %}
    <table class="payments-table compact-table">
      <thead>
        <tr>
          <th>Created</th>
          <th>Type</th>
          <th>Channel</th>
          <th>Bucket</th>
          <th>Dedup Key</th>
          <th>Status</th>
          <th>Message ID</th>
          <th>Delivered</th>
          <th>Error</th>
        </tr>
      </thead>
      <tbody>
        {% for row in delivery_logs %}
          <tr>
            <td>{{ row.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
            <td>{{ row.type }}</td>
            <td>{{ row.channel }}</td>
            <td>{{ row.bucket_date }}</td>
            <td><code>{{ row.dedup_key }}</code></td>
            <td>
              <span class="status-pill {% if row.status == 'sent' %}status-completed{% elif row.status == 'error' %}status-canceled{% else %}status-skipped{% endif %}">{{ row.status }}</span>
            </td>
            <td>{{ row.telegram_message_id or '-' }}</td>
            <td>{{ row.delivered_at.strftime('%Y-%m-%d %H:%M') if row.delivered_at else '-' }}</td>
            <td class="muted">{{ row.error_message or '-' }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    <div class="pager-row">
      <span class="muted">Showing {{ delivery_logs|length }} of {{ delivery_log_total }} log rows (page {{ delivery_log_page_num }})</span>
      <div class="inline-form">
        {% if delivery_log_has_prev %}
          <a class="link-btn" href="/notifications?page={{ notifications_page_num }}&per_page={{ notifications_per_page }}&sort={{ notifications_sort }}&log_page={{ delivery_log_page_num - 1 }}&log_per_page={{ delivery_log_per_page }}&log_sort={{ delivery_log_sort }}&log_type={{ delivery_log_filters.type }}&log_channel={{ delivery_log_filters.channel }}&log_status={{ delivery_log_filters.status }}&log_start_date={{ delivery_log_filters.start_date }}&log_end_date={{ delivery_log_filters.end_date }}">Previous</a>
        {% endif %}
        {% if delivery_log_has_next %}
          <a class="link-btn" href="/notifications?page={{ notifications_page_num }}&per_page={{ notifications_per_page }}&sort={{ notifications_sort }}&log_page={{ delivery_log_page_num + 1 }}&log_per_page={{ delivery_log_per_page }}&log_sort={{ delivery_log_sort }}&log_type={{ delivery_log_filters.type }}&log_channel={{ delivery_log_filters.channel }}&log_status={{ delivery_log_filters.status }}&log_start_date={{ delivery_log_filters.start_date }}&log_end_date={{ delivery_log_filters.end_date }}">Next</a>
        {% endif %}
      </div>
    </div>
  {% else %}
    <p class="muted">No delivery log entries yet.</p>
  {% endif %}
</section>
{% endblock %}
