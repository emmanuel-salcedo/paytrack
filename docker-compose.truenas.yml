services:
  paytrack-api:
    image: ghcr.io/emmanuel-salcedo/paytrack:latest
    container_name: paytrack-api
    environment:
      APP_MODE: api
      RUN_STARTUP_JOBS: "1"
      DATABASE_URL: ${DATABASE_URL:-sqlite:////data/paytrack.db}
      TZ: ${TZ:-America/Los_Angeles}
      DUE_SOON_DAYS: ${DUE_SOON_DAYS:-5}
      DAILY_SUMMARY_TIME: ${DAILY_SUMMARY_TIME:-07:00}
      SQLITE_BUSY_TIMEOUT_MS: ${SQLITE_BUSY_TIMEOUT_MS:-5000}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID:-}
    ports:
      - "${API_PORT:-3052}:8000"
    volumes:
      - paytrack_data:/data
    restart: unless-stopped

  paytrack-web:
    image: ghcr.io/emmanuel-salcedo/paytrack:latest
    container_name: paytrack-web
    environment:
      APP_MODE: web
      RUN_STARTUP_JOBS: "0"
      DATABASE_URL: ${DATABASE_URL:-sqlite:////data/paytrack.db}
      TZ: ${TZ:-America/Los_Angeles}
      DUE_SOON_DAYS: ${DUE_SOON_DAYS:-5}
      DAILY_SUMMARY_TIME: ${DAILY_SUMMARY_TIME:-07:00}
      SQLITE_BUSY_TIMEOUT_MS: ${SQLITE_BUSY_TIMEOUT_MS:-5000}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID:-}
    volumes:
      - paytrack_data:/data
    restart: unless-stopped

  paytrack-ui:
    image: nginx:1.27-alpine
    container_name: paytrack-ui
    depends_on:
      - paytrack-web
      - paytrack-api
    command:
      - /bin/sh
      - -c
      - |
        cat > /etc/nginx/conf.d/default.conf <<'EOF'
        server {
          listen 80;
          server_name _;
          client_max_body_size 10m;

          location / {
            proxy_pass http://paytrack-web:8000;
            proxy_http_version 1.1;
            proxy_set_header Host $$host;
            proxy_set_header X-Real-IP $$remote_addr;
            proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $$scheme;
          }

          location /api/ {
            proxy_pass http://paytrack-api:8000/api/;
            proxy_http_version 1.1;
            proxy_set_header Host $$host;
            proxy_set_header X-Real-IP $$remote_addr;
            proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $$scheme;
          }
        }
        EOF
        nginx -g 'daemon off;'
    ports:
      - "${UI_PORT:-3051}:80"
    restart: unless-stopped

volumes:
  paytrack_data:
