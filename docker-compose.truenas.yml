version: "3.8"

services:
  paytrack-api:
    image: ghcr.io/emmanuel-salcedo/paytrack:latest
    container_name: paytrack-api
    restart: unless-stopped
    ports:
      - "3052:8000"
    volumes:
      - /mnt/cerberus/apps/PayTrack/data:/data
    environment:
      APP_MODE: "api"
      RUN_STARTUP_JOBS: "1"
      TZ: "America/Los_Angeles"
      DATABASE_URL: "sqlite:////data/database.sqlite"
      SQLITE_BUSY_TIMEOUT_MS: "5000"

  paytrack-web:
    image: ghcr.io/emmanuel-salcedo/paytrack:latest
    container_name: paytrack-web
    restart: unless-stopped
    volumes:
      - /mnt/cerberus/apps/PayTrack/data:/data
    environment:
      APP_MODE: "web"
      RUN_STARTUP_JOBS: "0"
      TZ: "America/Los_Angeles"
      DATABASE_URL: "sqlite:////data/database.sqlite"
      SQLITE_BUSY_TIMEOUT_MS: "5000"

  paytrack-ui:
    image: nginx:1.27-alpine
    container_name: paytrack-ui
    restart: unless-stopped
    depends_on:
      - paytrack-web
      - paytrack-api
    ports:
      - "3051:80"
    command:
      - /bin/sh
      - -c
      - |
        cat > /etc/nginx/conf.d/default.conf <<'EOF'
        server {
          listen 80;
          server_name _;
          client_max_body_size 10m;

          location /static/ {
            proxy_pass http://paytrack-web:8000/static/;
            proxy_http_version 1.1;
            proxy_set_header Host $$host;
            proxy_set_header X-Real-IP $$remote_addr;
            proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $$scheme;
          }

          location /api/ {
            proxy_pass http://paytrack-api:8000/api/;
            proxy_http_version 1.1;
            proxy_set_header Host $$host;
            proxy_set_header X-Real-IP $$remote_addr;
            proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $$scheme;
          }

          location / {
            proxy_pass http://paytrack-web:8000/;
            proxy_http_version 1.1;
            proxy_set_header Host $$host;
            proxy_set_header X-Real-IP $$remote_addr;
            proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $$scheme;
          }
        }
        EOF
        nginx -g 'daemon off;'
